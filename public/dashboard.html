<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blazed One | Dashboard</title>
    
    <link href="css/fire.css" rel="stylesheet" />
    <link href="css/build.css" rel="stylesheet" />
    <script src="js/util.js"></script>
    <script src="js/fire.js"></script>
    <script src="js/dashboard.js"></script>
</head>
<body>

    <div id="load" class="text-center">
        <span class="loading loading-spinner loading-lg mt-10"></span>
    </div>
    <main id="content" class="w-full hidden">
        
    </main>
    <footer class="footer p-10 bg-base-200 text-base-content">
        <div>
            <a title="Blazed One" class="hover:opacity-75" href="/dashboard">
                <img src="https://blazed.sirv.com/logo/Beaker-Dark.png?w=64&h=64" />
            </a>
            <p>
                &copy; <time id="year"></time> Blazed Labs LLC
                <br/>
                <span class="text-xs text-gray-500 pt-3">
                    Turning dreams into reality since 2020.
                </span>
            </p>
        </div> 
        <div>
          <span class="footer-title text-gray-500 select-none">
            Company
          </span> 
          <a href="https://blazedlabs.com/" class="link link-hover">
            Blazed Labs
          </a> 
          <a href="https://blazed.company/" class="link link-hover">
            Corporate
          </a> 
          <a href="https://beez.top/" class="link link-hover">
            Marketing
          </a> 
          <a href="https://blazed.contact/" class="link link-hover">
            Contact
          </a>
        </div> 
        <div>
          <span class="footer-title text-gray-500 select-none">
            Resources
          </span> 
          <a href="https://blazed.systems/support" class="link link-hover">
            Support
          </a> 
          <a href="https://blazed.city/docs" class="link link-hover">
            Documentation
          </a> 
          <a href="https://blazed.city/government/intro/" class="link link-hover">
            Government
          </a> 
          <a href="https://blazed.dev/" class="link link-hover">
            Development
          </a>
        </div> 
        <div>
          <span class="footer-title text-gray-500 select-none">
            Legal
        </span> 
          <a href="https://blazedlabs.com/tos" class="link link-hover">
            Terms of Service
          </a> 
          <a href="https://blazedlabs.com/privacy" class="link link-hover">
            Privacy policy
          </a> 
          <a href="https://blazedlabs.com/dmca" class="link link-hover">
            DMCA policy
          </a>
        </div>
      </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, uploadBytes, getDownloadURL, ref } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        import getConfig from "./js/config.js";
  
        build_head();
  
        const firebaseConfig = getConfig();
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                //const uid = user.uid;

                const content = document.querySelector('#content');
                content.classList.remove('hidden');
                const queryPage = getPageQueryStrings();
                switch(queryPage.x){
                    case "settings":
                        content.innerHTML = settings(user);
                        const settingsForm = document.querySelector('#settings-form');
                        settingsForm.addEventListener("submit", (event) => {
                            event.preventDefault();
                            let newData = {
                                photoURL: user.photoURL,
                                displayName: user.displayName
                            };
                            
                            const displayNameField = document.querySelector("#field-display-name");
                            const photoUploadField = document.querySelector("#field-picture-upload");

                            if(photoUploadField.files.length === 1){
                                    //photoUploadField.files[0]
                                    const fileType = photoUploadField.files[0].name.split('.');
                                    const storageRef = ref(storage, `profile-img/${uuidv4()}.${fileType[1]}`);
                                        uploadBytes(storageRef, photoUploadField.files[0]).then((snapshot) => {
                                        //console.log('Uploaded the new profile picture!' + storageRef.fullPath);
                                        getDownloadURL(storageRef).then((url) => {
                                            updateProfile(user, {
                                                photoURL: url,
                                                displayName: displayNameField.value
                                            }).then(() => {
                                                window.location.href = "/dashboard";
                                            });
                                        });
                                    });

                                }

                            if(displayNameField.value.length === 0){
                                // no need to update display name if empty
                            } else {
                                updateProfile(user, { displayName: displayNameField.value
                                }).then(() => {
                                    window.location.href = "/dashboard";
                                });
                
                            }
                        });
                        break;
                    case "finance":
                        content.innerHTML = finance(user);
                        break;
                    case "my-profile":
                    default:
                        content.innerHTML = profile(user);
                        break;
                }
            } else {
                // User is signed out
                window.location.href = "/";
            }
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const year = document.querySelector('#year');
          year.innerHTML = GetCurrentYear();
          year.setAttribute('datetime', GetCurrentYear());
          const loading = document.querySelector('#load');
          loading.classList.add('hidden');
        });
      </script>
      
</body>